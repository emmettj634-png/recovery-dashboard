<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oklahoma Elite Recovery Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg:#841617;
  --card:rgba(255,255,255,.15);
  --text:#FDF9D8;
}
body {
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
}
.container {
  max-width:1400px;
  margin:auto;
  padding:20px;
}
h1 {
  text-align:center;
  font-size:3.8rem;
}
#modeBadge {
  text-align:center;
  font-size:.9rem;
  opacity:.8;
  margin-bottom:15px;
}
.controls {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:25px;
}
select,input[type="file"] {
  padding:10px;
  border-radius:6px;
  border:none;
}
input[type="file"] {
  display:none;
}
h2 { margin-top:40px; }

.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.stat-card {
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.hidden { display:none; }

.chart-box { height:400px; margin-top:20px; }

.module-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.module-card {
  background:var(--card);
  padding:12px;
  border-radius:8px;
}
.module-card h3 {
  border-bottom:1px solid rgba(253,249,216,.4);
  margin-bottom:8px;
}
.module-card ul {
  list-style:none;
  padding-left:0;
}
.module-card li {
  font-size:.9rem;
  margin-bottom:4px;
}
</style>
</head>

<body>
<div class="container">

<h1>Oklahoma Elite Recovery</h1>
<div id="modeBadge"></div>

<div class="controls">
  <select id="positionFilter">
    <option value="">Select Position</option>
    <option>QB</option><option>RB</option><option>WR</option><option>TE</option>
    <option>OL</option><option>DT</option><option>DE</option>
    <option>CB</option><option>S</option><option>LB</option><option>Specialists</option>
  </select>

  <select id="playerFilter">
    <option value="">Select Player</option>
  </select>

  <select id="dateFilter">
    <option value="">Select Date</option>
  </select>

  <input type="file" id="csvFile" accept=".csv">
</div>

<h2>Player Details</h2>
<div id="playerStatsGrid" class="stats-grid hidden">
  <div class="stat-card">Recovery Days<br><strong id="playerRecoveryDays">0</strong></div>
  <div class="stat-card">Last Recovery Date<br><strong id="playerLastDate">N/A</strong></div>
  <div class="stat-card">Most Popular Module<br><strong id="playerMostModule">-</strong></div>
  <div class="stat-card">Rank in Position<br><strong id="playerRank">-</strong></div>
</div>

<h2>Module Participation (Selected Date)</h2>
<div id="selectedDateLabel" style="text-align:center;font-weight:bold;"></div>
<div id="moduleGrid" class="module-grid"></div>

<h2>Average Daily Participation by Position (%)</h2>
<div class="chart-box"><canvas id="positionAvgChart"></canvas></div>

<h2>Total Team Module Usage</h2>
<div class="chart-box"><canvas id="moduleChart"></canvas></div>

</div>

<script>
/* ================= MODE DETECTION ================= */
const isAdmin = window.location.pathname.includes("admin");

const modeBadge = document.getElementById("modeBadge");
const csvInput = document.getElementById("csvFile");

if (isAdmin) {
  csvInput.style.display = "block";
  csvInput.disabled = false;
  modeBadge.textContent = "Admin View (CSV Upload Enabled)";
} else {
  csvInput.style.display = "none";
  csvInput.disabled = true;
  modeBadge.textContent = "User View (Read Only)";
}

/* ================= DOM ================= */
const positionFilter = document.getElementById("positionFilter");
const playerFilter = document.getElementById("playerFilter");
const dateFilter = document.getElementById("dateFilter");
const moduleGrid = document.getElementById("moduleGrid");
const selectedDateLabel = document.getElementById("selectedDateLabel");

const playerStatsGrid = document.getElementById("playerStatsGrid");
const playerRecoveryDays = document.getElementById("playerRecoveryDays");
const playerLastDate = document.getElementById("playerLastDate");
const playerMostModule = document.getElementById("playerMostModule");
const playerRank = document.getElementById("playerRank");

/* ================= CONFIG ================= */
const modules = [
  "Cryo","Red Light","Cold Tub","Hot Tub",
  "Massage Chair","Manual Massages","Cocoon"
];

/* ================= FULL ROSTER ================= */
const roster = [
  {name:"Ace Hodges",position:"OL"},
  {name:"Alex Shieldnight",position:"DE"},
  {name:"Andy Bass",position:"RB"},
  {name:"Barrett Travis",position:"LB"},
  {name:"Beau Jandreau",position:"LB"},
  {name:"Ben Anderson",position:"Specialists"},
  {name:"Ben McCreary",position:"RB"},
  {name:"Bergin Kysar",position:"DE"},
  {name:"Bishop Thomas",position:"DT"},
  {name:"Bowe Bentley",position:"QB"},
  {name:"Brian Harris",position:"DT"},
  {name:"CJ Nickson",position:"DE"},
  {name:"Caleb Nitta",position:"OL"},
  {name:"Casen Calmus",position:"S"},
  {name:"Cole Sullivan",position:"LB"},
  {name:"Courtland Guillory",position:"CB"},
  {name:"Dakoda Fields",position:"CB"},
  {name:"Dane Bathurst",position:"LB"},
  {name:"Daniel Akinkunmi",position:"OL"},
  {name:"Daniel Odom",position:"WR"},
  {name:"Danny Okoye",position:"DE"},
  {name:"Darius Afalava",position:"OL"},
  {name:"David Rowaiye",position:"DT"},
  {name:"David Stone",position:"DT"},
  {name:"DeZephen Walker",position:"RB"},
  {name:"Deacon Schmitt",position:"OL"},
  {name:"Derrick Johnson",position:"CB"},
  {name:"E'Marion Harris",position:"OL"},
  {name:"Eddy Pierre-Louis",position:"OL"},
  {name:"Eli Bowen",position:"CB"},
  {name:"Eli Merck",position:"WR"},
  {name:"Elijah Thomas",position:"WR"},
  {name:"Emmanuel Choice",position:"WR"},
  {name:"Fred Hinton",position:"OL"},
  {name:"Gabe Sawchuk",position:"RB"},
  {name:"Grayson Miller",position:"Specialists"},
  {name:"Gunnar Allen",position:"OL"},
  {name:"Hayden Hansen",position:"TE"},
  {name:"Heath Ozaeta",position:"OL"},
  {name:"Isaiah Sategna",position:"WR"},
  {name:"Ivan Carreon",position:"WR"},
  {name:"Jack Van Dorselaer",position:"TE"},
  {name:"Jacob Curry",position:"LB"},
  {name:"Jacob Henry",position:"DT"},
  {name:"Jacob Jordan",position:"WR"},
  {name:"Jacob Ulrich",position:"Specialists"},
  {name:"Jacobe Johnson",position:"CB"},
  {name:"Jahsiear Rogers",position:"WR"},
  {name:"Jake Kreul",position:"DE"},
  {name:"Jake Maikkula",position:"OL"},
  {name:"James Carrington",position:"DT"},
  {name:"James Nesta",position:"LB"},
  {name:"Jayden Jackson",position:"DT"},
  {name:"Jayden Petit",position:"WR"},
  {name:"Jer'Michael Carter",position:"WR"},
  {name:"Jeremiah Newcombe",position:"CB"},
  {name:"Jett Niu",position:"QB"},
  {name:"John Locke",position:"TE"},
  {name:"John Mateer",position:"QB"},
  {name:"Jonathan Hatton",position:"RB"},
  {name:"Kade McIntyre",position:"TE"},
  {name:"Kenneth Wermy",position:"OL"},
  {name:"Kenny Ozowalu",position:"DE"},
  {name:"Kip Lewis",position:"LB"},
  {name:"Kristan Moore",position:"LB"},
  {name:"Lebron Bauer",position:"CB"},
  {name:"Liam Evans",position:"Specialists"},
  {name:"Lloyd Avant",position:"RB"},
  {name:"Mackenzie Alleyne",position:"WR"},
  {name:"Marcus James",position:"LB"},
  {name:"Markel Ford",position:"S"},
  {name:"Matthew Nelson",position:"DE"},
  {name:"Michael Boganowski",position:"S"},
  {name:"Michael Fasusi",position:"OL"},
  {name:"Nigel Smith",position:"DT"},
  {name:"Niko Jandreau",position:"S"},
  {name:"Noah Best",position:"OL"},
  {name:"Omarion Robinson",position:"S"},
  {name:"Owen Hollenbeck",position:"OL"},
  {name:"PJ Adebawore",position:"DE"},
  {name:"Parker Livingstone",position:"WR"},
  {name:"Peyton Bowen",position:"S"},
  {name:"Peyton Joseph",position:"OL"},
  {name:"Preston Mickens",position:"CB"},
  {name:"Preston Tarpley",position:"Specialists"},
  {name:"Prince Ijioma",position:"CB"},
  {name:"Reed DeQuasie",position:"S"},
  {name:"Reggie Powers",position:"S"},
  {name:"Rocky Beers",position:"TE"},
  {name:"Ryan Fodje",position:"OL"},
  {name:"Ryder Mix",position:"TE"},
  {name:"Sean Hutton",position:"OL"},
  {name:"Seth Freeman",position:"Specialists"},
  {name:"Tate Sandell",position:"Specialists"},
  {name:"Taylor Heim",position:"LB"},
  {name:"Taylor Wein",position:"DE"},
  {name:"Tory Blaylock",position:"RB"},
  {name:"Trace Rudd",position:"Specialists"},
  {name:"Trell Harris",position:"WR"},
  {name:"Trent Wilson",position:"DT"},
  {name:"Trey Brown",position:"WR"},
  {name:"Trynae Washington",position:"TE"},
  {name:"Trystan Haynes",position:"CB"},
  {name:"Tyler Ruxer",position:"TE"},
  {name:"Whitt Newbauer",position:"QB"},
  {name:"Wyatt Gilmore",position:"DE"},
  {name:"Xavier Robinson",position:"RB"},
  {name:"eLGee Webster",position:"LB"}
];

/* ================= DATA ================= */
let playerData =
  JSON.parse(localStorage.getItem("recoveryData")) ||
  roster.map(p=>({name:p.name,position:p.position,sessions:[]}));

function saveData(){
  localStorage.setItem("recoveryData",JSON.stringify(playerData));
}

const uniqueDates = p => [...new Set(p.sessions.map(s=>s.date))];

function parseDate(d){
  if(!d) return null;
  if(d.includes("/")){
    const [m,da,y]=d.split("/").map(Number);
    return `${y}-${String(m).padStart(2,"0")}-${String(da).padStart(2,"0")}`;
  }
  return d;
}
function fmt(d){
  const [y,m,da]=d.split("-");
  return `${+m}/${+da}/${y}`;
}

/* ================= DROPDOWNS ================= */
function populatePlayers(){
  playerFilter.innerHTML='<option value="">Select Player</option>';
  playerData.filter(p=>p.position===positionFilter.value)
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(p=>{
      const o=document.createElement("option");
      o.value=p.name;
      o.textContent=p.name;
      playerFilter.appendChild(o);
    });
}

function populateDates(){
  const dates=[...new Set(playerData.flatMap(p=>p.sessions.map(s=>s.date)))].sort();
  dateFilter.innerHTML='<option value="">Select Date</option>';
  dates.forEach(d=>{
    const o=document.createElement("option");
    o.value=d;
    o.textContent=fmt(d);
    dateFilter.appendChild(o);
  });
  if(dates.length) dateFilter.value=dates[dates.length-1];
}

/* ================= MODULE GRID ================= */
function renderModules(){
  moduleGrid.innerHTML="";
  selectedDateLabel.textContent="";
  if(!positionFilter.value || !dateFilter.value) return;

  selectedDateLabel.textContent = `${fmt(dateFilter.value)} â€” ${positionFilter.value}`;

  modules.forEach(mod=>{
    const card=document.createElement("div");
    card.className="module-card";
    card.innerHTML=`<h3>${mod}</h3><ul></ul>`;
    const ul=card.querySelector("ul");

    playerData.filter(p=>p.position===positionFilter.value)
      .filter(p=>p.sessions.some(s=>s.module===mod && s.date===dateFilter.value))
      .forEach(p=>{
        const li=document.createElement("li");
        li.textContent=p.name;
        ul.appendChild(li);
      });

    moduleGrid.appendChild(card);
  });
}

/* ================= PLAYER VIEW ================= */
function showPlayer(){
  const p=playerData.find(x=>x.name===playerFilter.value);
  if(!p) return;

  playerStatsGrid.classList.remove("hidden");
  playerRecoveryDays.textContent = uniqueDates(p).length;

  const last = uniqueDates(p).sort().pop();
  playerLastDate.textContent = last ? fmt(last) : "N/A";

  const mods={};
  p.sessions.forEach(s=>mods[s.module]=(mods[s.module]||0)+1);
  playerMostModule.textContent =
    Object.keys(mods).sort((a,b)=>mods[b]-mods[a])[0] || "N/A";

  const rank = playerData
    .filter(x=>x.position===p.position)
    .sort((a,b)=>uniqueDates(b).length-uniqueDates(a).length)
    .findIndex(x=>x.name===p.name) + 1;

  playerRank.textContent = `#${rank}`;
}

/* ================= CSV IMPORT (ADMIN ONLY) ================= */
if(isAdmin){
  csvInput.addEventListener("change",e=>{
    const file=e.target.files[0];
    if(!file) return;

    playerData.forEach(p=>p.sessions=[]);

    const reader=new FileReader();
    reader.onload=ev=>{
      ev.target.result.split("\n").slice(1).forEach(r=>{
        if(!r.trim()) return;
        const [name,module,date]=r.split(",").map(x=>x.trim());
        const iso=parseDate(date);
        const p=playerData.find(x=>x.name===name);
        if(p && iso) p.sessions.push({module,date:iso});
      });
      saveData();
      populateDates();
      refreshCharts();
      renderModules();
    };
    reader.readAsText(file);
  });
}

/* ================= CHARTS ================= */
let positionChart=null;
let moduleChart=null;

function refreshCharts(){
  /* Avg Daily Participation by Position */
  const posDayCounts={};

  playerData.forEach(p=>{
    uniqueDates(p).forEach(d=>{
      if(!posDayCounts[p.position]) posDayCounts[p.position]={};
      posDayCounts[p.position][d]=(posDayCounts[p.position][d]||0)+1;
    });
  });

  const labels=Object.keys(posDayCounts);
  const values=labels.map(pos=>{
    const total=roster.filter(r=>r.position===pos).length;
    const daily=Object.values(posDayCounts[pos]).map(c=>(c/total)*100);
    return daily.length
      ? (daily.reduce((a,b)=>a+b)/daily.length).toFixed(1)
      : 0;
  });

  if(positionChart) positionChart.destroy();
  positionChart=new Chart(document.getElementById("positionAvgChart"),{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Avg Daily Participation (%)",
        data:values,
        backgroundColor:"rgba(253,249,216,.8)"
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{
          beginAtZero:true,
          max:100,
          ticks:{
            color:"#FDF9D8",
            callback:v=>v+"%"
          }
        },
        x:{ticks:{color:"#FDF9D8"}}
      },
      plugins:{legend:{labels:{color:"#FDF9D8"}}}
    }
  });

  /* Total Team Module Usage */
  const totals={};
  modules.forEach(m=>totals[m]=0);
  playerData.forEach(p=>p.sessions.forEach(s=>totals[s.module]++));

  if(moduleChart) moduleChart.destroy();
  moduleChart=new Chart(document.getElementById("moduleChart"),{
    type:"bar",
    data:{
      labels:Object.keys(totals),
      datasets:[{
        label:"Total Uses",
        data:Object.values(totals),
        backgroundColor:"rgba(253,249,216,.8)"
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{ticks:{color:"#FDF9D8"}},
        x:{ticks:{color:"#FDF9D8"}}
      },
      plugins:{legend:{labels:{color:"#FDF9D8"}}}
    }
  });
}

/* ================= EVENTS ================= */
positionFilter.addEventListener("change",()=>{
  populatePlayers();
  renderModules();
});
playerFilter.addEventListener("change",showPlayer);
dateFilter.addEventListener("change",renderModules);

/* ================= INIT ================= */
populateDates();
refreshCharts();
</script>
</body>
</html>
