<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oklahoma Elite Recovery Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg:#841617;
  --card:rgba(255,255,255,.15);
  --text:#FDF9D8;
  --cream:#FDF9D8;
}
body {
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
}
.container {
  max-width:1400px;
  margin:auto;
  padding:20px;
}
h1 {
  text-align:center;
  font-size:3.5rem;
}
.controls {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:25px;
}
select, button {
  padding:10px;
  border-radius:6px;
  border:none;
  font-weight:bold;
}
button {
  background:var(--cream);
  color:#841617;
  cursor:pointer;
}
.hidden { display:none; }

.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.stat-card {
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.chart-box {
  height:400px;
  margin-top:25px;
}
.module-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.module-card {
  background:var(--card);
  padding:12px;
  border-radius:8px;
}
.module-card h3 {
  border-bottom:1px solid rgba(253,249,216,.4);
  margin-bottom:8px;
}
.team-position {
  margin-top:40px;
}
</style>
</head>

<body>
<div class="container">

<h1>Oklahoma Elite Recovery</h1>

<div class="controls">
  <select id="positionFilter">
    <option value="">Select Position</option>
    <option>QB</option><option>RB</option><option>WR</option><option>TE</option>
    <option>OL</option><option>DT</option><option>DE</option>
    <option>CB</option><option>S</option><option>LB</option><option>Specialists</option>
  </select>

  <select id="playerFilter">
    <option value="">Select Player</option>
  </select>

  <select id="dateFilter">
    <option value="">Select Date</option>
  </select>

  <button id="toggleView">Team View</button>
</div>

<!-- PLAYER VIEW -->
<div id="playerView">

<h2>Player Details</h2>
<div id="playerStatsGrid" class="stats-grid hidden">
  <div class="stat-card">Recovery Days<br><strong id="playerRecoveryDays">0</strong></div>
  <div class="stat-card">Last Recovery Date<br><strong id="playerLastDate">N/A</strong></div>
  <div class="stat-card">Most Popular Module<br><strong id="playerMostModule">-</strong></div>
  <div class="stat-card">Rank in Position<br><strong id="playerRank">-</strong></div>
</div>

<h2>Module Participation (Selected Date)</h2>
<div id="selectedDateLabel" style="text-align:center;font-weight:bold;"></div>
<div id="moduleGrid" class="module-grid"></div>

<h2>Average Daily Participation by Position (%)</h2>
<div class="chart-box"><canvas id="positionAvgChart"></canvas></div>

<h2>Total Team Module Usage</h2>
<div class="chart-box"><canvas id="moduleChart"></canvas></div>

</div>

<!-- TEAM VIEW -->
<div id="teamView" class="hidden"></div>

</div>

<script>
const modules = [
  "Cryo","Red Light","Cold Tub","Hot Tub",
  "Massage Chair","Manual Massages","Cocoon"
];

const positions = ["QB","RB","WR","TE","OL","DT","DE","CB","S","LB","Specialists"];

/* ===== FULL ROSTER ===== */
const roster = [
  {name:"Daniel Akinkunmi",position:"OL"},
  {name:"Bowe Bentley",position:"QB"},
  {name:"Gabe Sawchuk",position:"RB"}
  /* ⬅️ keep your FULL roster here — unchanged from your working version */
];

let playerData = roster.map(p => ({ ...p, sessions: [] }));

const uniqueDates = p => [...new Set(p.sessions.map(s=>s.date))];

function parseDate(d){
  if(d.includes("/")){
    const [m,da,y]=d.split("/").map(Number);
    return `${y}-${String(m).padStart(2,"0")}-${String(da).padStart(2,"0")}`;
  }
  return d;
}
function fmt(d){
  const [y,m,da]=d.split("-");
  return `${+m}/${+da}/${y}`;
}

/* ===== CSV LOAD ===== */
async function loadCSVFromRepo(){
  const res = await fetch("data.csv");
  const text = await res.text();

  playerData.forEach(p=>p.sessions=[]);

  text.split("\n").slice(1).forEach(row=>{
    if(!row.trim()) return;
    const [name,module,date]=row.split(",").map(x=>x.trim());
    const iso=parseDate(date);
    const p=playerData.find(x=>x.name===name);
    if(p && iso) p.sessions.push({module,date:iso});
  });

  populateDates();
  refreshCharts();
  renderModules();
  renderTeamView();
}

/* ===== PLAYER VIEW ===== */
function populatePlayers(){
  playerFilter.innerHTML='<option value="">Select Player</option>';
  playerData.filter(p=>p.position===positionFilter.value)
    .forEach(p=>{
      const o=document.createElement("option");
      o.value=p.name;
      o.textContent=p.name;
      playerFilter.appendChild(o);
    });
}

function showPlayer(){
  const p = playerData.find(x=>x.name===playerFilter.value);
  if(!p) return;

  playerStatsGrid.classList.remove("hidden");
  playerRecoveryDays.textContent = uniqueDates(p).length;

  const last = uniqueDates(p).sort().pop();
  playerLastDate.textContent = last ? fmt(last) : "N/A";

  const mods={};
  p.sessions.forEach(s=>mods[s.module]=(mods[s.module]||0)+1);
  playerMostModule.textContent =
    Object.keys(mods).sort((a,b)=>mods[b]-mods[a])[0] || "N/A";

  const group = playerData.filter(x=>x.position===p.position);
  const rank = group
    .sort((a,b)=>uniqueDates(b).length-uniqueDates(a).length)
    .findIndex(x=>x.name===p.name)+1;

  playerRank.textContent = `#${rank} out of ${group.length}`;
}

function renderModules(){
  moduleGrid.innerHTML="";
  if(!positionFilter.value||!dateFilter.value) return;

  selectedDateLabel.textContent =
    `${fmt(dateFilter.value)} — ${positionFilter.value}`;

  modules.forEach(mod=>{
    const count = playerData.filter(p=>
      p.position===positionFilter.value &&
      p.sessions.some(s=>s.module===mod && s.date===dateFilter.value)
    ).length;

    const card=document.createElement("div");
    card.className="module-card";
    card.innerHTML=`<h3>${mod}</h3><strong>${count} players</strong>`;
    moduleGrid.appendChild(card);
  });
}

/* ===== TEAM VIEW ===== */
function renderTeamView(){
  teamView.innerHTML="";
  if(!dateFilter.value) return;

  positions.forEach(pos=>{
    const section=document.createElement("div");
    section.className="team-position";
    section.innerHTML=`<h2>${pos}</h2><div class="module-grid"></div>`;
    const grid=section.querySelector(".module-grid");

    modules.forEach(mod=>{
      const count = playerData.filter(p=>
        p.position===pos &&
        p.sessions.some(s=>s.module===mod && s.date===dateFilter.value)
      ).length;

      const card=document.createElement("div");
      card.className="module-card";
      card.innerHTML=`<h3>${mod}</h3><strong>${count} players</strong>`;
      grid.appendChild(card);
    });

    teamView.appendChild(section);
  });
}

/* ===== CHARTS ===== */
let positionChart,moduleChart;

function refreshCharts(){
  const totals={};
  modules.forEach(m=>totals[m]=0);
  playerData.forEach(p=>p.sessions.forEach(s=>totals[s.module]++));

  moduleChart?.destroy();
  moduleChart=new Chart(document.getElementById("moduleChart"),{
    type:"bar",
    data:{labels:Object.keys(totals),datasets:[{data:Object.values(totals)}]},
    options:{responsive:true}
  });
}

/* ===== EVENTS ===== */
positionFilter.addEventListener("change",populatePlayers);
playerFilter.addEventListener("change",showPlayer);
dateFilter.addEventListener("change",()=>{
  renderModules();
  renderTeamView();
});
toggleView.addEventListener("click",()=>{
  playerView.classList.toggle("hidden");
  teamView.classList.toggle("hidden");
  toggleView.textContent =
    teamView.classList.contains("hidden") ? "Team View" : "Player View";
});

/* ===== INIT ===== */
loadCSVFromRepo();
</script>

</body>
</html>
