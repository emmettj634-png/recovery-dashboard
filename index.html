
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="header">
<title>Oklahoma Elite Recovery Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>


/* === Trend arrows === */
.trend-up.light { color: #9BE7A6; }    /* light green */
.trend-up.medium { color: #4CAF50; }  /* medium green */
.trend-up.dark { color: #1B5E20; }    /* dark green */

.trend-down.light { color: #F28B82; }  /* light red */
.trend-down.medium { color: #E53935; } /* medium red */
.trend-down.dark { color: #8E0000; }   /* dark red */

.empty-state{
  text-align:center;
  font-style:italic;
  opacity:0.8;
  padding:20px;
}

:root{
  --bg-core:#8E1B1C;
  --bg-edge:#5A0E0F;
  --card:rgba(255,255,255,.15);
  --text:#FDF9D8;
}

body{
  background-color: #6F1213;
  background:
    radial-gradient(
      circle at top center,
      var(--bg-core) 0%,
      #6F1213 45%,
      var(--bg-edge) 100%
    );
  background-attachment: fixed; /* ‚úÖ THIS LINE */
  color:var(--text);
  font-family:Arial, sans-serif;
  position: relative;
}

/* =====================
   DESKTOP STRONGER GRADIENT
====================== */
@media (min-width: 769px){
  body{
    background:
      radial-gradient(
        circle at 50% 18%,
        #9A1F21 0%,
        #7A1416 35%,
        #4A0C0D 100%
      );
    background-attachment: fixed;
  }
}


body::before{
  content:"";
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>\
<filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/></filter>\
<rect width='120' height='120' filter='url(%23n)' opacity='0.03'/></svg>");
  pointer-events:none;
  z-index:-1;
}



.container{
  max-width:1400px;
  margin:auto;
  padding:20px;
}
h1{text-align:center;font-size:3.9rem;}
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:25px;
}
select,button{
  padding:10px;
  border-radius:6px;
  border:none;
  font-weight:bold;
}
button{cursor:pointer;}
.hidden{display:none;}

.stats-grid,.module-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.stat-card,.module-card{
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.module-card h3{
  border-bottom:1px solid rgba(253,249,216,.4);
  margin-bottom:6px;
}
.module-card ul{list-style:none;padding-left:0;}
.module-card li{font-size:.9rem;}

.chart-box{
  height:380px;
  margin-top:25px;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chart-box canvas{max-width:900px;}

.team-position{margin-top:40px;}
.team-position h2{text-align:center;}

.leaderboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:25px;
  justify-content:center;
  max-width:1200px;
  margin:0 auto;
}
.leaderboard{
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.leaderboard h3{text-align:center;}
.leaderboard li{color:#FDF9D8;}

/* =====================
   FROSTED GLASS CARDS
====================== */

.stat-card,
.module-card,
.leaderboard{
  background: rgba(255,255,255,0.22);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow:
    0 10px 25px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.15);
  border-radius: 10px;
}

@media (max-width: 768px){
  body{
    background: #6F1213 !important; /* force non-white */
    background-attachment: scroll;
  }
}


</style>
</head>

<body>
<div class="container">

<div class="header">
  
<h1>Oklahoma Elite Recovery</h1>
  
<div class="controls">
  <select id="positionFilter">
    <option value="">Select Position</option>
    <option>QB</option><option>RB</option><option>WR</option><option>TE</option>
    <option>OL</option><option>DT</option><option>DE</option>
    <option>CB</option><option>S</option><option>LB</option><option>Specialists</option>
  </select>

  <select id="playerFilter">
    <option value="">Select Player</option>
  </select>

  <select id="dateFilter">
    <option value="">Select Date</option>
  </select>

  <button id="toggleView">Team View</button>
</div>

<!-- ================= PLAYER VIEW ================= -->
<div id="playerView">

<h2 id="playerDetailsTitle">Player Details</h2>
<div id="playerStatsGrid" class="stats-grid hidden">
  <div class="stat-card">Recovery Days<br><strong id="playerRecoveryDays">0</strong></div>
  <div class="stat-card">Last Recovery Date<br><strong id="playerLastDate">N/A</strong></div>
  <div class="stat-card">Most Popular Module<br><strong id="playerMostModule">-</strong></div>
  <div class="stat-card">Rank in Position<br><strong id="playerRank">-</strong></div>
</div>

<h2 id="positionModuleTitle">Module Participation</h2>
<div id="selectedDateLabel" style="text-align:center;font-weight:bold;"></div>
<div id="moduleGrid" class="module-grid"></div>

<h2 id="playerModuleTitle">Cumulative Module Usage</h2>
<div class="chart-box" id="playerModuleContainer">
  <div class="empty-state">Select a player to view cumulative module usage</div>
  <canvas id="playerModuleChart" style="display:none;"></canvas>
</div>


<h2>Average Daily Participation by Position (%)</h2>
<div class="chart-box"><canvas id="avgChart"></canvas></div>

  <h2>Average Monthly Participation by Position (%)</h2>
<div class="controls">
  <select id="monthFilter"></select>
  <select id="monthWeekFilter"></select>
</div>
<div class="chart-box">
  <canvas id="monthlyAvgChart"></canvas>
</div>

<h2>Total Team Module Usage (All Dates)</h2>
<div class="chart-box"><canvas id="moduleChart"></canvas></div>

</div>

<!-- ================= TEAM VIEW ================= -->
<div id="teamView" class="hidden">

<h2 style="text-align:center;">Team Module Participation (Selected Date)</h2>
<div id="teamModuleGrid"></div>

<hr style="margin:40px 0;opacity:.4;">

<h2 style="text-align:center;">Weekly Participation Leaderboard</h2>
<div style="text-align:center;margin-bottom:15px;">
  <select id="weekFilter"></select>
</div>

<div id="leaderboardContainer" class="leaderboard-grid"></div>

</div>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
function inputDatesAllowDecline(prevInputs, currentInputs) {
  // Current week must exist visually
  if (currentInputs === 0) return false;

  // Same input counts allowed (down to 2 ‚Üí 2)
  if (prevInputs === currentInputs && prevInputs >= 2) {
    return true;
  }

  // -1 pattern allowed from 7 down to 3
  if (
    prevInputs >= 3 &&
    prevInputs <= 7 &&
    prevInputs - currentInputs === 1
  ) {
    return true;
  }

  return false;
}

function teamInputDatesInRange(start, end) {
  const dates = new Set();

  playerData.forEach(p => {
    p.sessions.forEach(s => {
      const d = new Date(s.date);
      if (d >= start && d <= end) {
        dates.add(s.date);
      }
    });
  });

  return dates.size;
}

  
function trendIndicator(
  current,
  previous,
  currentInputs,
  previousInputs
){

  // No data either week
  if (previous === 0 && current === 0) return "";

  /* =====================
     SPECIAL CASES
  ====================== */

  // 0 ‚Üí 1 = light green improvement
  if(previous === 0 && current === 1){
    return `<span class="trend-up light"> ‚ñ≤</span>`;
  }

  // 0 ‚Üí 2 = small positive momentum
  if(previous === 0 && current === 2){
    return `<span class="trend-up light"> ‚ñ≤</span>`;
  }

  // 2 ‚Üí 3 = light green improvement
  if(previous === 2 && current === 3){
    return `<span class="trend-up light"> ‚ñ≤</span>`;
  }

  // 2 ‚Üí 0 = explicit decline exception (UNCHANGED)
  if(previous === 2 && current === 0){
    return `<span class="trend-down medium"> ‚ñº</span>`;
  }

/* =====================
   DECLINE LOGIC (RED)
====================== */

// üî¥ Dark red: 3 ‚Üí 0 recovery days
if (previous === 3 && current === 0) {
  return `<span class="trend-down dark"> ‚ñº</span>`;
}

// üî¥ Medium red: 2 ‚Üí 0 recovery days
if (previous === 2 && current === 0) {
  return `<span class="trend-down medium"> ‚ñº</span>`;
}

// ‚ùå Block low-level single-step noise
if (
  (previous === 3 && current === 2) ||
  (previous === 2 && current === 1) ||
  (previous === 1 && current === 0)
) {
  return "";
}

// Standard decline (after input-date eligibility)
if (
  current < previous &&
  inputDatesAllowDecline(previousInputs, currentInputs)
) {
  const percentDrop = (previous - current) / previous;

  if (percentDrop >= 0.2857) {
    return `<span class="trend-down light"> ‚ñº</span>`;
  }
}



  /* =====================
     IMPROVEMENT LOGIC (GREEN)
  ====================== */

  if(current > 2 && current > previous){
    const change = previous === 0 ? 1 : (current - previous) / previous;

    // Cutoff +16%
    if(change >= 0.16){
      let level = "light";
      if(change >= 0.75) level = "dark";
      else if(change >= 0.5) level = "medium";

      return `<span class="trend-up ${level}"> ‚ñ≤</span>`;
    }
  }

  return "";
}

function fmtDate(d){
  const x = new Date(d);
  return `${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}-${x.getFullYear()}`;
}
const monthKey = d => {
  const x = new Date(d);
  return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}`;
};
const weekRange = d => {
  const x = new Date(d);
  const start = new Date(x);
  start.setDate(x.getDate() - x.getDay()); // Sunday start
  const end = new Date(start);
  end.setDate(start.getDate() + 6);

  const fmt = y =>
    `${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}-${y.getFullYear()}`;

  return {
    start,
    end,
    label: `${fmt(start)}-${fmt(end)}`
  };
};
const weekOfMonth = d => {
  const x = new Date(d);
  const first = new Date(x.getFullYear(), x.getMonth(), 1);
  return Math.ceil((x.getDate() + first.getDay()) / 7);
};

/* ================= CONSTANTS ================= */
const cream="#FDF9D8";
const modules=["Cryo","Red Light","Cold Tub","Hot Tub","Massage Chair","Manual Massages","Cocoon"];
const positions=["QB","RB","WR","TE","OL","DT","DE","CB","S","LB","Specialists"];
const monthFilter = document.getElementById("monthFilter");
const monthWeekFilter = document.getElementById("monthWeekFilter");

/* ================= FULL ROSTER ================= */
const roster = [
  {name:"Ace Hodges",position:"OL"},
  {name:"Alex Shieldnight",position:"DE"},
  {name:"Andy Bass",position:"RB"},
  {name:"Barrett Travis",position:"LB"},
  {name:"Beau Jandreau",position:"LB"},
  {name:"Ben Anderson",position:"Specialists"},
  {name:"Ben McCreary",position:"RB"},
  {name:"Bergin Kysar",position:"DE"},
  {name:"Bishop Thomas",position:"DT"},
  {name:"Bowe Bentley",position:"QB"},
  {name:"Brian Harris",position:"DT"},
  {name:"CJ Nickson",position:"DE"},
  {name:"Caleb Nitta",position:"OL"},
  {name:"Casen Calmus",position:"S"},
  {name:"Cole Sullivan",position:"LB"},
  {name:"Courtland Guillory",position:"CB"},
  {name:"Dakoda Fields",position:"CB"},
  {name:"Dane Bathurst",position:"LB"},
  {name:"Daniel Akinkunmi",position:"OL"},
  {name:"Daniel Odom",position:"WR"},
  {name:"Danny Okoye",position:"DE"},
  {name:"Darius Afalava",position:"OL"},
  {name:"David Rowaiye",position:"DT"},
  {name:"David Stone",position:"DT"},
  {name:"DeZephen Walker",position:"RB"},
  {name:"Deacon Schmitt",position:"OL"},
  {name:"Derrick Johnson",position:"CB"},
  {name:"E'Marion Harris",position:"OL"},
  {name:"Eddy Pierre-Louis",position:"OL"},
  {name:"Eli Bowen",position:"CB"},
  {name:"Eli Merck",position:"WR"},
  {name:"Elijah Thomas",position:"WR"},
  {name:"Emmanuel Choice",position:"WR"},
  {name:"Fred Hinton",position:"OL"},
  {name:"Gabe Sawchuk",position:"RB"},
  {name:"Grayson Miller",position:"Specialists"},
  {name:"Gunnar Allen",position:"OL"},
  {name:"Hayden Hansen",position:"TE"},
  {name:"Heath Ozaeta",position:"OL"},
  {name:"Isaiah Sategna",position:"WR"},
  {name:"Ivan Carreon",position:"WR"},
  {name:"Jack Van Dorselaer",position:"TE"},
  {name:"Jacob Curry",position:"LB"},
  {name:"Jacob Henry",position:"DT"},
  {name:"Jacob Jordan",position:"WR"},
  {name:"Jacob Ulrich",position:"Specialists"},
  {name:"Jacobe Johnson",position:"CB"},
  {name:"Jahsiear Rogers",position:"WR"},
  {name:"Jake Kreul",position:"DE"},
  {name:"Jake Maikkula",position:"OL"},
  {name:"James Carrington",position:"DT"},
  {name:"James Nesta",position:"LB"},
  {name:"Jayden Jackson",position:"DT"},
  {name:"Jayden Petit",position:"WR"},
  {name:"Jer'Michael Carter",position:"WR"},
  {name:"Jeremiah Newcombe",position:"CB"},
  {name:"Jett Niu",position:"QB"},
  {name:"John Locke",position:"TE"},
  {name:"John Mateer",position:"QB"},
  {name:"Jonathan Hatton",position:"RB"},
  {name:"Kade McIntyre",position:"TE"},
  {name:"Kenneth Wermy",position:"OL"},
  {name:"Kenny Ozowalu",position:"DE"},
  {name:"Kip Lewis",position:"LB"},
  {name:"Kristan Moore",position:"LB"},
  {name:"Liam Evans",position:"Specialists"},
  {name:"Lloyd Avant",position:"RB"},
  {name:"Mackenzie Alleyne",position:"WR"},
  {name:"Marcus James",position:"LB"},
  {name:"Markel Ford",position:"S"},
  {name:"Matthew Nelson",position:"DE"},
  {name:"Michael Boganowski",position:"S"},
  {name:"Michael Fasusi",position:"OL"},
  {name:"Nigel Smith",position:"DT"},
  {name:"Niko Jandreau",position:"S"},
  {name:"Noah Best",position:"OL"},
  {name:"Omarion Robinson",position:"S"},
  {name:"Owen Hollenbeck",position:"OL"},
  {name:"PJ Adebawore",position:"DE"},
  {name:"Parker Livingstone",position:"WR"},
  {name:"Peyton Bowen",position:"S"},
  {name:"Peyton Joseph",position:"OL"},
  {name:"Preston Mickens",position:"CB"},
  {name:"Preston Tarpley",position:"Specialists"},
  {name:"Prince Ijioma",position:"CB"},
  {name:"Reed DeQuasie",position:"S"},
  {name:"Reggie Powers",position:"S"},
  {name:"Rocky Beers",position:"TE"},
  {name:"Ryan Fodje",position:"OL"},
  {name:"Ryder Mix",position:"TE"},
  {name:"Sean Hutton",position:"OL"},
  {name:"Seth Freeman",position:"Specialists"},
  {name:"Tate Sandell",position:"Specialists"},
  {name:"Taylor Heim",position:"LB"},
  {name:"Taylor Wein",position:"DE"},
  {name:"Tory Blaylock",position:"RB"},
  {name:"Trace Rudd",position:"Specialists"},
  {name:"Trell Harris",position:"WR"},
  {name:"Trent Wilson",position:"DT"},
  {name:"Trey Brown",position:"WR"},
  {name:"Trynae Washington",position:"TE"},
  {name:"Trystan Haynes",position:"CB"},
  {name:"Tyler Ruxer",position:"TE"},
  {name:"Whitt Newbauer",position:"QB"},
  {name:"Wyatt Gilmore",position:"DE"},
  {name:"Xavier Robinson",position:"RB"},
  {name:"eLGee Webster",position:"LB"}
];

let playerData=roster.map(p=>({...p,sessions:[]}));
const uniqueDates=p=>[...new Set(p.sessions.map(s=>s.date))];

/* ================= CSV LOAD ================= */
async function loadCSV(){
  const res=await fetch("eliterecoverykey.csv?v="+Date.now());
  const text=await res.text();
  playerData.forEach(p=>p.sessions=[]);

  text.split("\n").slice(1).forEach(r=>{
    if(!r.trim())return;
    const[n,m,d]=r.split(",").map(x=>x.trim());
    const p=playerData.find(x=>x.name===n);
    if(p)p.sessions.push({module:m,date:d});
  });

  populateDates();
  populatePlayers();
  renderModules();
  renderCharts();
  populateMonths();
  renderMonthlyAvgChart();
}
loadCSV();

/* ================= DROPDOWNS ================= */
let mostRecentDate = null;
function populateDates(){
  const dates = [...new Set(
    playerData.flatMap(p => p.sessions.map(s => s.date))
  )].sort((a,b) => new Date(b) - new Date(a));

  dateFilter.innerHTML = '<option value="">Select Date</option>';

  dates.forEach(d=>{
    const o = document.createElement("option");
    o.value = d;
    o.textContent = fmtDate(d);
    dateFilter.appendChild(o);
  });

  if(dates.length){
    mostRecentDate = dates[0]; // üî• save newest date
  }
}

function populatePlayers(){
  playerFilter.innerHTML='<option value="">Select Player</option>';
  if(!positionFilter.value)return;
  playerData.filter(p=>p.position===positionFilter.value)
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(p=>{
      const o=document.createElement("option");
      o.value=p.name;o.textContent=p.name;
      playerFilter.appendChild(o);
    });
}
function populateMonths(){
  const months = [
    ...new Set(playerData.flatMap(p =>
      p.sessions.map(s => monthKey(s.date))
    ))
  ].sort().reverse(); // most recent first

  monthFilter.innerHTML = "";
  months.forEach(m=>{
    const o=document.createElement("option");
    o.value=m;
    o.textContent=m;
    monthFilter.appendChild(o);
  });

  populateMonthWeeks();
}
function populateMonthWeeks(){
  monthWeekFilter.innerHTML = `<option value="all">All Weeks</option>`;

  const weeks = {};

  playerData.forEach(p=>{
    p.sessions.forEach(s=>{
      if(monthKey(s.date) !== monthFilter.value) return;
      const w = weekRange(s.date);
      weeks[w.label] = w; // dedupe by label
    });
  });

  Object.values(weeks)
    .sort((a,b)=>b.start - a.start) // most recent first
    .forEach(w=>{
      const o = document.createElement("option");
      o.value = w.label;       // store label as value
      o.textContent = w.label;
      monthWeekFilter.appendChild(o);
    });
}


/* ================= PLAYER DETAILS ================= */
let playerModuleChart=null;
function showPlayer(){
  const p=playerData.find(x=>x.name===playerFilter.value);
  if(!p)return;
  // Show chart, hide empty state
document.querySelector("#playerModuleContainer .empty-state").style.display = "none";
document.getElementById("playerModuleChart").style.display = "block";

// Update title
document.getElementById("playerModuleTitle").textContent =
  `Cumulative Module Usage ‚Äì ${p.name}`;

  document.getElementById("playerDetailsTitle").textContent =
  `Player Details ‚Äì ${p.name}`;
  playerStatsGrid.classList.remove("hidden");
  playerRecoveryDays.textContent=uniqueDates(p).length;
  playerLastDate.textContent=uniqueDates(p).sort().pop()||"N/A";
  document.getElementById("playerModuleTitle").textContent =
  `Cumulative Module Usage ‚Äì ${p.name}`;
 
  const mods={};
  p.sessions.forEach(s=>mods[s.module]=(mods[s.module]||0)+1);
  playerMostModule.textContent=Object.keys(mods).sort((a,b)=>mods[b]-mods[a])[0]||"N/A";

  const group=playerData.filter(x=>x.position===p.position);
  const rank=group.sort((a,b)=>uniqueDates(b).length-uniqueDates(a).length)
    .findIndex(x=>x.name===p.name)+1;
  playerRank.textContent=`#${rank} out of ${group.length}`;

  renderPlayerModuleChart(p);
}

/* ================= MODULE PARTICIPATION ================= */
function renderModules(){
  moduleGrid.innerHTML="";

  const pos = positionFilter.value;
  const date = dateFilter.value;

  if(!pos){
    document.getElementById("positionModuleTitle").textContent =
      "Module Participation";
    moduleGrid.innerHTML =
      `<div class="empty-state">Select a position to view module participation</div>`;
    return;
  }

  let activeDate = date;
  if(!activeDate && mostRecentDate){
    activeDate = mostRecentDate;
  }

  document.getElementById("positionModuleTitle").textContent =
    `${pos} Module Participation ‚Äì ${fmtDate(activeDate)}`;

  modules.forEach(mod=>{
    const card = document.createElement("div");
    card.className = "module-card";
    card.innerHTML = `<h3>${mod}</h3><ul></ul>`;
    const ul = card.querySelector("ul");

    playerData
      .filter(p => p.position === pos)
      .forEach(p=>{
        const count = p.sessions.filter(
          s => s.module === mod && s.date === activeDate
        ).length;

        if(count > 0){
          const li = document.createElement("li");
          li.textContent = count > 1 ? `${p.name} x${count}` : p.name;
          ul.appendChild(li);
        }
      });

    moduleGrid.appendChild(card);
  });
}

/* ================= TEAM VIEW ================= */
function renderTeamView(){
  teamModuleGrid.innerHTML="";
  positions.forEach(pos=>{
    const sec=document.createElement("div");
    sec.className="team-position";
    sec.innerHTML=`<h2>${pos}</h2><div class="module-grid"></div>`;
    const grid=sec.querySelector(".module-grid");

    modules.forEach(mod=>{
      const card=document.createElement("div");
      card.className="module-card";
      card.innerHTML=`<h3>${mod}</h3><ul></ul>`;
      const ul=card.querySelector("ul");

      playerData.filter(p=>p.position===pos).forEach(p=>{
        const count=p.sessions.filter(s=>s.module===mod&&s.date===dateFilter.value).length;
        if(count>0){
          const li=document.createElement("li");
          li.textContent=count>1?`${p.name} x${count}`:p.name;
          ul.appendChild(li);
        }
      });

      grid.appendChild(card);
    });

    teamModuleGrid.appendChild(sec);
  });

  populateWeeks();
  renderLeaderboards();
}

/* ================= WEEKLY LEADERBOARD ================= */
function getWeekRange(dateStr){
  const d=new Date(dateStr);
  const start=new Date(d);start.setDate(d.getDate()-d.getDay());
  const end=new Date(start);end.setDate(start.getDate()+6);
  return{label:`${start.toLocaleDateString()} - ${end.toLocaleDateString()}`,start,end};
}
function populateWeeks(){
  weekFilter.innerHTML = "";
  const weeks = {};

  playerData.forEach(p=>{
    p.sessions.forEach(s=>{
      const w = getWeekRange(s.date);
      weeks[w.label] = w;
    });
  });

  const sortedWeeks = Object.values(weeks)
    .sort((a,b) => b.start - a.start);

  sortedWeeks.forEach(w=>{
    const o = document.createElement("option");
    o.value = w.label;
    o.textContent = w.label;
    weekFilter.appendChild(o);
  });

  if(sortedWeeks.length){
    weekFilter.value = sortedWeeks[0].label;
  }
}
function uniqueDaysInRange(player, start, end){
  return new Set(
    player.sessions
      .filter(s => {
        const d = new Date(s.date);
        return d >= start && d <= end;
      })
      .map(s => s.date)
  ).size;
}

function getEarliestWeekStart(){
  const dates = playerData.flatMap(p =>
    p.sessions.map(s => new Date(s.date))
  );

  if(!dates.length) return null;

  const earliest = new Date(Math.min(...dates));
  earliest.setDate(earliest.getDate() - earliest.getDay()); // normalize to week start
  earliest.setHours(0,0,0,0);

  return earliest;
}

function weekIsMatureEnough(currentInputs, previousInputs){
  if (previousInputs === 0) return false;
  return (currentInputs / previousInputs) >= 0.713;
}

function renderLeaderboards(){
  leaderboardContainer.innerHTML="";
  if(!weekFilter.value) return;
  const weeklyLeaderboard = [];

  const [s, e] = weekFilter.value.split(" - ");
  const start = new Date(s);
  const end = new Date(e);

  const earliestWeekStart = getEarliestWeekStart();

  /* =====================
     STEP 3 ‚Äî TEAM INPUT DATES
  ====================== */

  const thisWeekInputs = teamInputDatesInRange(start, end);

  const lastWeekStart = new Date(start);
  lastWeekStart.setDate(lastWeekStart.getDate() - 7);

  const lastWeekEnd = new Date(end);
  lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);

  const lastWeekInputs = teamInputDatesInRange(lastWeekStart, lastWeekEnd);

  /* =====================
     LEADERBOARD LOOP
  ====================== */

  const thisWeekInputs = teamInputDatesInRange(start, end);

const lastWeekStart = new Date(start);
lastWeekStart.setDate(lastWeekStart.getDate() - 7);

const lastWeekEnd = new Date(end);
lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);

const lastWeekInputs = teamInputDatesInRange(lastWeekStart, lastWeekEnd);

// üîí maturity gate
const weekIsReady =
  weekIsMatureEnough(thisWeekInputs, lastWeekInputs);
  
  positions.forEach(pos => {
    const group = playerData.filter(p => p.position === pos);

    // ... rest of your existing code

  const ranked = group.length
    ? group.map(p => {
        const thisWeekDays = uniqueDaysInRange(p, start, end);

        const lastWeekStart = new Date(start);
        lastWeekStart.setDate(lastWeekStart.getDate() - 7);

        const lastWeekEnd = new Date(end);
        lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);

        const lastWeekDays = uniqueDaysInRange(p, lastWeekStart, lastWeekEnd);

        let trend = "";

if (
  earliestWeekStart &&
  start.getTime() !== earliestWeekStart.getTime() &&
  weekIsReady
) {
  trend = trendIndicator(
    thisWeekDays,
    lastWeekDays,
    thisWeekInputs,
    lastWeekInputs
  );
}



        

        return {
          name: p.name,
          days: thisWeekDays,
          trend
        };
      })
    : [
        {
          name: "‚Äî",
          days: 0,
          trend: ""
        }
      ];

  // store for charts if needed
  weeklyLeaderboard.push({
    position: pos,
    players: ranked
  });

  /* =====================
     LEADERBOARD RENDER
  ====================== */

  const top = ranked
    .filter(p => p.days > 0)
    .sort((a, b) => b.days - a.days)
    .slice(0, 5);

  const bottom = ranked
    .filter(p => !top.some(t => t.name === p.name))
    .sort((a, b) => a.days - b.days)
    .slice(0, 5);

  const div = document.createElement("div");
  div.className = "leaderboard";

  let html = `<h3>${pos}</h3><strong>Top Performers</strong><ol>`;
  top.forEach(p => {
    html += `<li>${p.name}${p.trend || ""}</li>`;
  });
  html += `</ol>`;

  if (group.length > 5) {
    html += `<strong>Bottom Performers</strong><ol>`;
    bottom.forEach(p => {
      html += `<li>${p.name}${p.trend || ""}</li>`;
    });
    html += `</ol>`;
  }

  div.innerHTML = html;
  leaderboardContainer.appendChild(div);
});

}
  
/* ================= CHARTS ================= */
let avgChart=null,teamChart=null;
function renderCharts(){
  const posDay={};
  playerData.forEach(p=>{
    uniqueDates(p).forEach(d=>{
      posDay[p.position]??={};
      posDay[p.position][d]=(posDay[p.position][d]||0)+1;
    });
  });

  const labels=Object.keys(posDay);
  const values=labels.map(pos=>{
    const total=roster.filter(r=>r.position===pos).length;
    const days=Object.values(posDay[pos]).map(c=>(c/total)*100);
    return days.length?(days.reduce((a,b)=>a+b)/days.length).toFixed(1):0;
  });

  avgChart?.destroy();
  avgChart=new Chart(
    document.getElementById("avgChart"),
    {
      type:"bar",
      data:{labels,datasets:[{label:"%",data:values,backgroundColor:cream}]},
      options:{
        scales:{
          x:{ticks:{color:cream}},
          y:{ticks:{color:cream,callback:v=>v+"%"},beginAtZero:true,max:100}
        },
        plugins:{legend:{labels:{color:cream}}}
      }
    }
  );

  const totals={};
  modules.forEach(m=>totals[m]=0);
  playerData.forEach(p=>p.sessions.forEach(s=>totals[s.module]++));

  teamChart?.destroy();
  teamChart=new Chart(
    document.getElementById("moduleChart"),
    {
      type:"bar",
      data:{
        labels:Object.keys(totals),
        datasets:[{label:"Total Uses",data:Object.values(totals),backgroundColor:cream}]
      },
      options:{
        scales:{
          x:{ticks:{color:cream}},
          y:{ticks:{color:cream},beginAtZero:true}
        },
        plugins:{legend:{labels:{color:cream}}}
      }
    }
  );
}
function renderPlayerModuleChart(p){
  // üîé Check if player has any usage at all
if(p.sessions.length === 0){
  document.getElementById("playerModuleChart").style.display = "none";
  document.querySelector("#playerModuleContainer .empty-state").style.display = "block";
  document.querySelector("#playerModuleContainer .empty-state").textContent =
    "No module usage yet for this player";
  return;
}

  const totals = {};
  const latestDates = {};

  modules.forEach(m=>{
    totals[m] = 0;
    latestDates[m] = null;
  });

  // Count uses + track most recent date per module
  p.sessions.forEach(s=>{
    totals[s.module]++;
    if(
      !latestDates[s.module] ||
      new Date(s.date) > new Date(latestDates[s.module])
    ){
      latestDates[s.module] = s.date;
    }
  });

  playerModuleChart?.destroy();

  playerModuleChart = new Chart(
    document.getElementById("playerModuleChart"),
    {
      type: "bar",
      data: {
        labels: modules, // ‚úÖ module names ONLY
        datasets: [{
          data: modules.map(m => totals[m]),
          backgroundColor: cream
        }]
      },
      options: {
        scales: {
          x: {
            ticks: { color: cream }

          },
          y: {
            ticks: { color: cream },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const mod = ctx.label;
                const date = latestDates[mod] || "N/A";
                return [
                  `Total Uses: ${ctx.parsed.y}`,
                  `Latest Date: ${date}`
                ];
              }
            }
          }
        }
      }
    }
  );
}
let monthlyAvgChart = null;

function renderMonthlyAvgChart(){
  const posDay = {};

  playerData.forEach(p=>{
    const dates = new Set();

    p.sessions.forEach(s=>{
      if(monthKey(s.date) !== monthFilter.value) return;
      if(monthWeekFilter.value !== "all"){
  const w = weekRange(s.date);
  if(w.label !== monthWeekFilter.value) return;
}
      dates.add(s.date);
    });

    dates.forEach(d=>{
      posDay[p.position] ??= {};
      posDay[p.position][d] = (posDay[p.position][d] || 0) + 1;
    });
  });

  const labels = Object.keys(posDay);
  const values = labels.map(pos=>{
    const rosterSize = roster.filter(r=>r.position===pos).length;
    const days = Object.values(posDay[pos]).map(c => (c/rosterSize)*100);
    return days.length
      ? (days.reduce((a,b)=>a+b)/days.length).toFixed(1)
      : 0;
  });

  monthlyAvgChart?.destroy();
  monthlyAvgChart = new Chart(
    document.getElementById("monthlyAvgChart"),
    {
      type:"bar",
      data:{
        labels,
        datasets:[{
          data:values,
          backgroundColor:cream
        }]
      },
      options:{
        scales:{
          x:{ ticks:{ color:cream }},
          y:{
            min:0,
            max:100,
            ticks:{
              color:cream,
              callback:v=>v+"%"
            }
          }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label:ctx=>ctx.parsed.y+"%"
            }
          }
        }
      }
    }
  );
}

/* ================= EVENTS ================= */
positionFilter.onchange = () => {
  populatePlayers();

  // üî• Auto-select most recent date if none selected
  if(!dateFilter.value && mostRecentDate){
    dateFilter.value = mostRecentDate;
  }

  renderModules();
};

playerFilter.onchange = () => {

  // üîÑ Player cleared
  if(!playerFilter.value){
    // Reset titles
    document.getElementById("playerDetailsTitle").textContent = "Player Details";
    document.getElementById("playerModuleTitle").textContent = "Cumulative Module Usage";

    // Hide player stats
    playerStatsGrid.classList.add("hidden");

    // Hide chart, show empty state
    document.getElementById("playerModuleChart").style.display = "none";
    document.querySelector("#playerModuleContainer .empty-state").style.display = "block";

    return;
  }

  // ‚úÖ Player selected
  showPlayer();
};

dateFilter.onchange = () => {
  // Update player-view module participation
  renderModules();

  // ‚úÖ ALSO update team-view module participation if Team View is active
  if (!teamView.classList.contains("hidden")) {
    renderTeamView();
  }
};
toggleView.onclick = () => {
  const toTeam = teamView.classList.contains("hidden");

  // Toggle views
  playerView.classList.toggle("hidden");
  teamView.classList.toggle("hidden");

  // Hide irrelevant dropdowns in Team View
  playerFilter.classList.toggle("hidden");
  positionFilter.classList.toggle("hidden");

  // Update button label
  toggleView.textContent = toTeam ? "Player View" : "Team View";

  // Render team modules immediately when entering Team View
  if (toTeam) {
    renderTeamView();
  }
};
weekFilter.onchange=renderLeaderboards;
monthFilter.onchange = () => {
  populateMonthWeeks();
  renderMonthlyAvgChart();
};

monthWeekFilter.onchange = renderMonthlyAvgChart;
});
</script>

</body>
</html>
