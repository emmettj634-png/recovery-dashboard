<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oklahoma Elite Recovery Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#841617;
  --card:rgba(255,255,255,.15);
  --text:#FDF9D8;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
}
.container{max-width:1400px;margin:auto;padding:20px;}
h1{text-align:center;font-size:3.5rem;}
.controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:25px;}
select,button{padding:10px;border-radius:6px;border:none;font-weight:bold;}
button{cursor:pointer;}
.hidden{display:none;}

.stats-grid,.module-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.stat-card,.module-card{
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.module-card h3{
  border-bottom:1px solid rgba(253,249,216,.4);
  margin-bottom:6px;
}
.module-card ul{list-style:none;padding-left:0;}
.module-card li{font-size:.9rem;}

.chart-box{
  height:380px;
  margin-top:25px;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chart-box canvas{max-width:900px;}

.team-position{margin-top:40px;}
.team-position h2{text-align:center;}

.leaderboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:25px;
  max-width:1200px;
  margin:0 auto;
}
.leaderboard{
  background:var(--card);
  padding:15px;
  border-radius:8px;
}
.leaderboard h3{text-align:center;}
</style>
</head>

<body>
<div class="container">

<h1>Oklahoma Elite Recovery</h1>

<div class="controls">
  <select id="positionFilter">
    <option value="">Select Position</option>
    <option>QB</option><option>RB</option><option>WR</option><option>TE</option>
    <option>OL</option><option>DT</option><option>DE</option>
    <option>CB</option><option>S</option><option>LB</option><option>Specialists</option>
  </select>

  <select id="playerFilter"><option value="">Select Player</option></select>
  <select id="dateFilter"><option value="">Select Date</option></select>
  <button id="toggleView">Team View</button>
</div>

<!-- PLAYER VIEW -->
<div id="playerView">

<h2>Player Details</h2>
<div id="playerStatsGrid" class="stats-grid hidden">
  <div class="stat-card">Recovery Days<br><strong id="playerRecoveryDays"></strong></div>
  <div class="stat-card">Last Recovery Date<br><strong id="playerLastDate"></strong></div>
  <div class="stat-card">Most Popular Module<br><strong id="playerMostModule"></strong></div>
  <div class="stat-card">Rank in Position<br><strong id="playerRank"></strong></div>
</div>

<h2>Module Participation (Selected Date)</h2>
<div id="selectedDateLabel" style="text-align:center;font-weight:bold;"></div>
<div id="moduleGrid" class="module-grid"></div>

<h2>Cumulative Module Usage (Selected Player)</h2>
<div class="chart-box"><canvas id="playerModuleChart"></canvas></div>

<h2>Average Daily Participation by Position (%)</h2>
<div class="chart-box"><canvas id="avgChart"></canvas></div>

<h2>Total Team Module Usage (All Dates)</h2>
<div class="chart-box"><canvas id="moduleChart"></canvas></div>

</div>

<!-- TEAM VIEW -->
<div id="teamView" class="hidden">

<h2 style="text-align:center;">Team Module Participation (Selected Date)</h2>
<div id="teamModuleGrid"></div>

<hr style="margin:40px 0;opacity:.4;">

<h2 style="text-align:center;">Weekly Participation Leaderboard</h2>
<div style="text-align:center;margin-bottom:15px;">
  <select id="weekFilter"></select>
</div>

<div id="leaderboardContainer" class="leaderboard-grid"></div>

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* ================= HELPERS ================= */
const fmtDate = d => {
  const x=new Date(d);
  return `${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}-${x.getFullYear()}`;
};
const parseDate = d => new Date(d);
const desc = (a,b)=>parseDate(b)-parseDate(a);

/* ================= DOM ================= */
const $=id=>document.getElementById(id);
const positionFilter=$("positionFilter"),
playerFilter=$("playerFilter"),
dateFilter=$("dateFilter"),
toggleView=$("toggleView"),
playerView=$("playerView"),
teamView=$("teamView"),
moduleGrid=$("moduleGrid"),
teamModuleGrid=$("teamModuleGrid"),
leaderboardContainer=$("leaderboardContainer"),
playerStatsGrid=$("playerStatsGrid"),
playerRecoveryDays=$("playerRecoveryDays"),
playerLastDate=$("playerLastDate"),
playerMostModule=$("playerMostModule"),
playerRank=$("playerRank"),
selectedDateLabel=$("selectedDateLabel"),
weekFilter=$("weekFilter");

/* ================= CONSTANTS ================= */
const cream="#FDF9D8";
const modules=["Cryo","Red Light","Cold Tub","Hot Tub","Massage Chair","Manual Massages","Cocoon"];
const positions=["QB","RB","WR","TE","OL","DT","DE","CB","S","LB","Specialists"];

/* ================= ROSTER ================= */
const roster = [
  {name:"Ace Hodges",position:"OL"},{name:"Alex Shieldnight",position:"DE"},
  {name:"Andy Bass",position:"RB"},{name:"Barrett Travis",position:"LB"},
  {name:"Beau Jandreau",position:"LB"},{name:"Ben Anderson",position:"Specialists"},
  {name:"Ben McCreary",position:"RB"},{name:"Bergin Kysar",position:"DE"},
  {name:"Bishop Thomas",position:"DT"},{name:"Bowe Bentley",position:"QB"},
  {name:"Brian Harris",position:"DT"},{name:"CJ Nickson",position:"DE"},
  {name:"Caleb Nitta",position:"OL"},{name:"Casen Calmus",position:"S"},
  {name:"Cole Sullivan",position:"LB"},{name:"Courtland Guillory",position:"CB"},
  {name:"Dakoda Fields",position:"CB"},{name:"Dane Bathurst",position:"LB"},
  {name:"Daniel Akinkunmi",position:"OL"},{name:"Daniel Odom",position:"WR"},
  {name:"Danny Okoye",position:"DE"},{name:"Darius Afalava",position:"OL"},
  {name:"David Rowaiye",position:"DT"},{name:"David Stone",position:"DT"},
  {name:"DeZephen Walker",position:"RB"},{name:"Deacon Schmitt",position:"OL"},
  {name:"Derrick Johnson",position:"CB"},{name:"E'Marion Harris",position:"OL"},
  {name:"Eddy Pierre-Louis",position:"OL"},{name:"Eli Bowen",position:"CB"},
  {name:"Eli Merck",position:"WR"},{name:"Elijah Thomas",position:"WR"},
  {name:"Emmanuel Choice",position:"WR"},{name:"Fred Hinton",position:"OL"},
  {name:"Gabe Sawchuk",position:"RB"},{name:"Grayson Miller",position:"Specialists"},
  {name:"Gunnar Allen",position:"OL"},{name:"Hayden Hansen",position:"TE"},
  {name:"Heath Ozaeta",position:"OL"},{name:"Isaiah Sategna",position:"WR"},
  {name:"Ivan Carreon",position:"WR"},{name:"Jack Van Dorselaer",position:"TE"},
  {name:"Jacob Curry",position:"LB"},{name:"Jacob Henry",position:"DT"},
  {name:"Jacob Jordan",position:"WR"},{name:"Jacob Ulrich",position:"Specialists"},
  {name:"Jacobe Johnson",position:"CB"},{name:"Jahsiear Rogers",position:"WR"},
  {name:"Jake Kreul",position:"DE"},{name:"Jake Maikkula",position:"OL"},
  {name:"James Carrington",position:"DT"},{name:"James Nesta",position:"LB"},
  {name:"Jayden Jackson",position:"DT"},{name:"Jayden Petit",position:"WR"},
  {name:"Jer'Michael Carter",position:"WR"},{name:"Jeremiah Newcombe",position:"CB"},
  {name:"Jett Niu",position:"QB"},{name:"John Locke",position:"TE"},
  {name:"John Mateer",position:"QB"},{name:"Jonathan Hatton",position:"RB"},
  {name:"Kade McIntyre",position:"TE"},{name:"Kenneth Wermy",position:"OL"},
  {name:"Kenny Ozowalu",position:"DE"},{name:"Kip Lewis",position:"LB"},
  {name:"Kristan Moore",position:"LB"},{name:"Liam Evans",position:"Specialists"},
  {name:"Lloyd Avant",position:"RB"},{name:"Mackenzie Alleyne",position:"WR"},
  {name:"Marcus James",position:"LB"},{name:"Markel Ford",position:"S"},
  {name:"Matthew Nelson",position:"DE"},{name:"Michael Boganowski",position:"S"},
  {name:"Michael Fasusi",position:"OL"},{name:"Nigel Smith",position:"DT"},
  {name:"Niko Jandreau",position:"S"},{name:"Noah Best",position:"OL"},
  {name:"Omarion Robinson",position:"S"},{name:"Owen Hollenbeck",position:"OL"},
  {name:"PJ Adebawore",position:"DE"},{name:"Parker Livingstone",position:"WR"},
  {name:"Peyton Bowen",position:"S"},{name:"Peyton Joseph",position:"OL"},
  {name:"Preston Mickens",position:"CB"},{name:"Preston Tarpley",position:"Specialists"},
  {name:"Prince Ijioma",position:"CB"},{name:"Reed DeQuasie",position:"S"},
  {name:"Reggie Powers",position:"S"},{name:"Rocky Beers",position:"TE"},
  {name:"Ryan Fodje",position:"OL"},{name:"Ryder Mix",position:"TE"},
  {name:"Sean Hutton",position:"OL"},{name:"Seth Freeman",position:"Specialists"},
  {name:"Tate Sandell",position:"Specialists"},{name:"Taylor Heim",position:"LB"},
  {name:"Taylor Wein",position:"DE"},{name:"Tory Blaylock",position:"RB"},
  {name:"Trace Rudd",position:"Specialists"},{name:"Trell Harris",position:"WR"},
  {name:"Trent Wilson",position:"DT"},{name:"Trey Brown",position:"WR"},
  {name:"Trynae Washington",position:"TE"},{name:"Trystan Haynes",position:"CB"},
  {name:"Tyler Ruxer",position:"TE"},{name:"Whitt Newbauer",position:"QB"},
  {name:"Wyatt Gilmore",position:"DE"},{name:"Xavier Robinson",position:"RB"},
  {name:"eLGee Webster",position:"LB"}
];

let playerData=roster.map(p=>({...p,sessions:[]}));
const uniqueDates=p=>[...new Set(p.sessions.map(s=>s.date))];

/* ================= LOAD CSV ================= */
fetch("data.csv?v="+Date.now()).then(r=>r.text()).then(text=>{
  text.split("\n").slice(1).forEach(r=>{
    if(!r.trim())return;
    const[n,m,d]=r.split(",").map(x=>x.trim());
    const p=playerData.find(x=>x.name===n);
    if(p)p.sessions.push({module:m,date:d});
  });
  populateDates(); populatePlayers();
  renderTotalModuleChart(); renderDailyAvg(); populateWeeks();
});

/* ================= DROPDOWNS ================= */
function populateDates(){
  const dates=[...new Set(playerData.flatMap(p=>p.sessions.map(s=>s.date)))]
    .sort(desc);
  dateFilter.innerHTML='<option value="">Select Date</option>';
  dates.forEach(d=>dateFilter.innerHTML+=`<option value="${d}">${fmtDate(d)}</option>`);
}
function populatePlayers(){
  playerFilter.innerHTML='<option value="">Select Player</option>';
  if(!positionFilter.value)return;
  playerData.filter(p=>p.position===positionFilter.value)
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(p=>playerFilter.innerHTML+=`<option>${p.name}</option>`);
}

/* ================= MODULE PARTICIPATION ================= */
function renderModules(){
  moduleGrid.innerHTML="";
  if(!positionFilter.value||!dateFilter.value)return;
  selectedDateLabel.textContent=`${fmtDate(dateFilter.value)} â€” ${positionFilter.value}`;

  modules.forEach(mod=>{
    const card=document.createElement("div");
    card.className="module-card";
    card.innerHTML=`<h3>${mod}</h3><ul></ul>`;
    const ul=card.querySelector("ul");

    playerData.filter(p=>p.position===positionFilter.value).forEach(p=>{
      const c=p.sessions.filter(s=>s.module===mod&&s.date===dateFilter.value).length;
      if(c)ul.innerHTML+=`<li>${p.name}${c>1?" x"+c:""}</li>`;
    });

    moduleGrid.appendChild(card);
  });
}

/* ================= PLAYER DETAILS + TOOLTIP ================= */
let playerModuleChart=null;
function showPlayer(){
  const p=playerData.find(x=>x.name===playerFilter.value);
  if(!p)return;
  playerStatsGrid.classList.remove("hidden");

  playerRecoveryDays.textContent=uniqueDates(p).length;
  playerLastDate.textContent=fmtDate(uniqueDates(p).sort(desc)[0]);

  const totals={}, lastDates={};
  modules.forEach(m=>{totals[m]=0;lastDates[m]=null;});

  p.sessions.forEach(s=>{
    totals[s.module]++;
    if(!lastDates[s.module]||parseDate(s.date)>parseDate(lastDates[s.module])){
      lastDates[s.module]=s.date;
    }
  });

  playerMostModule.textContent=Object.keys(totals).sort((a,b)=>totals[b]-totals[a])[0];

  const peers=playerData.filter(x=>x.position===p.position)
    .sort((a,b)=>uniqueDates(b).length-uniqueDates(a).length);
  playerRank.textContent=`#${peers.findIndex(x=>x.name===p.name)+1} of ${peers.length}`;

  playerModuleChart?.destroy();
  playerModuleChart=new Chart($("playerModuleChart"),{
    type:"bar",
    data:{labels:modules,datasets:[{data:Object.values(totals),backgroundColor:cream}]},
    options:{
      scales:{x:{ticks:{color:cream}},y:{ticks:{color:cream},beginAtZero:true}},
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const mod=ctx.label;
              const last=lastDates[mod]?fmtDate(lastDates[mod]):"N/A";
              return [`Total Uses: ${ctx.parsed.y}`,`Last Used: ${last}`];
            }
          }
        }
      }
    }
  });
}

/* ================= TOTAL TEAM MODULE ================= */
let moduleChart=null;
function renderTotalModuleChart(){
  const totals={};modules.forEach(m=>totals[m]=0);
  playerData.forEach(p=>p.sessions.forEach(s=>totals[s.module]++));
  moduleChart?.destroy();
  moduleChart=new Chart($("moduleChart"),{
    type:"bar",
    data:{labels:modules,datasets:[{data:Object.values(totals),backgroundColor:cream}]},
    options:{scales:{x:{ticks:{color:cream}},y:{ticks:{color:cream},beginAtZero:true}},
             plugins:{legend:{display:false}}}
  });
}

/* ================= DAILY AVG ================= */
function renderDailyAvg(){
  const posDay={};
  playerData.forEach(p=>uniqueDates(p).forEach(d=>{
    posDay[p.position]??={};
    posDay[p.position][d]=(posDay[p.position][d]||0)+1;
  }));
  new Chart($("avgChart"),{
    type:"bar",
    data:{labels:Object.keys(posDay),
      datasets:[{data:Object.keys(posDay).map(pos=>{
        const t=roster.filter(r=>r.position===pos).length;
        const d=Object.values(posDay[pos]).map(c=>c/t*100);
        return(d.reduce((a,b)=>a+b)/d.length).toFixed(1);
      }),backgroundColor:cream}]},
    options:{scales:{y:{min:0,max:100,ticks:{color:cream,callback:v=>v+"%"}},
                    x:{ticks:{color:cream}}},
             plugins:{legend:{display:false}}}
  });
}

/* ================= WEEKLY LEADERBOARD ================= */
function populateWeeks(){
  const weeks={};
  playerData.forEach(p=>p.sessions.forEach(s=>{
    const d=parseDate(s.date);
    const start=new Date(d);start.setDate(d.getDate()-d.getDay());
    const label=`${fmtDate(start)} - ${fmtDate(new Date(start.getTime()+6*86400000))}`;
    weeks[label]=start;
  }));
  weekFilter.innerHTML="";
  Object.entries(weeks).sort((a,b)=>b[1]-a[1])
    .forEach(([l])=>weekFilter.innerHTML+=`<option>${l}</option>`);
}
function renderLeaderboards(){
  leaderboardContainer.innerHTML="";
  if(!weekFilter.value)return;
  const [s]=weekFilter.value.split(" - ");
  const start=parseDate(s);
  positions.forEach(pos=>{
    const ranked=playerData.filter(p=>p.position===pos).map(p=>{
      const days=[...new Set(p.sessions.filter(x=>{
        const d=parseDate(x.date);
        return d>=start && d<new Date(start.getTime()+7*86400000);
      }).map(x=>x.date))].length;
      return{name:p.name,days};
    }).sort((a,b)=>b.days-a.days);
    const top=ranked.filter(p=>p.days>0).slice(0,5);
    if(!top.length)return;
    leaderboardContainer.innerHTML+=
      `<div class="leaderboard"><h3>${pos}</h3><ol>${top.map(p=>`<li>${p.name}</li>`).join("")}</ol></div>`;
  });
}

/* ================= EVENTS ================= */
positionFilter.onchange=()=>{populatePlayers();renderModules();};
dateFilter.onchange=renderModules;
playerFilter.onchange=showPlayer;
toggleView.onclick=()=>{
  const toTeam=teamView.classList.contains("hidden");
  playerView.classList.toggle("hidden");
  teamView.classList.toggle("hidden");
  toggleView.textContent=toTeam?"Player View":"Team View";
  if(toTeam)renderLeaderboards();
};
weekFilter.onchange=renderLeaderboards;

});
</script>
</body>
</html>
